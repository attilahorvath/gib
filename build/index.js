!function(){"use strict";var t="uniform mat4 projection;uniform mat4 view;uniform float spriteSize;attribute vec3 vertexPosition;attribute vec2 vertexTexCoord;varying vec2 texCoord;void main(){texCoord=vertexTexCoord;gl_Position=projection*view*vec4(vertexPosition,1.0);gl_PointSize=spriteSize;}",e="precision highp float;uniform sampler2D tex;uniform vec2 tileSize;uniform vec2 texSize;varying vec2 texCoord;void main(){vec2 texCoord=mix((tileSize*texCoord)/texSize,(tileSize*(texCoord+vec2(1.0,1.0)))/texSize,gl_PointCoord);gl_FragColor=texture2D(tex,texCoord);if(gl_FragColor.a<0.1){discard;}}";function s(t,e){switch(e){case t.FLOAT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:return 4;case t.FLOAT_MAT3:return 9;case t.FLOAT_MAT4:return 16}}class i{constructor(t,e,i){this.gl=t;const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e),t.compileShader(r);const h=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(h,i),t.compileShader(h),this.program=t.createProgram(),t.attachShader(this.program,r),t.attachShader(this.program,h),t.linkProgram(this.program),this.uniforms=[];const a=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<a;e++){const s=t.getActiveUniform(this.program,e),i=t.getUniformLocation(this.program,s.name);this[s.name]=null,this.uniforms.push({type:s.type,name:s.name,location:i})}this.attributes=[],this.stride=0;const n=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let e=0;e<n;e++){const i=t.getActiveAttrib(this.program,e),r=t.getAttribLocation(this.program,i.name),h=s(t,i.type);this.attributes.push({name:i.name,location:r,components:h}),this.stride+=4*h}}use(){this.gl.useProgram(this.program);let t=0;for(const e of this.attributes)this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.components,this.gl.FLOAT,!1,this.stride,t),t+=4*e.components;for(const t of this.uniforms)switch(t.type){case this.gl.FLOAT:this.gl.uniform1f(t.location,this[t.name]);break;case this.gl.FLOAT_VEC2:this.gl.uniform2fv(t.location,this[t.name]);break;case this.gl.FLOAT_MAT2:this.gl.uniformMatrix2fv(t.location,!1,this[t.name]);break;case this.gl.FLOAT_MAT4:this.gl.uniformMatrix4fv(t.location,!1,this[t.name])}}}const r="textures/tiles.png",h=128,a=32,n=16,o=64;class l{constructor(s,l){this.TILES_TEXTURE_WIDTH=h,this.TILES_TEXTURE_HEIGHT=a,this.TILE_SIZE=n,this.SPRITE_SIZE=o,this.width=s,this.height=l;const c=document.createElement("canvas");c.width=s,c.height=l,document.body.appendChild(c),this.gl=c.getContext("webgl",{antialias:!1}),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,.53,1,1),this.spriteShader=new i(this.gl,t,e),this.spriteShader.texSize=new Float32Array([h,a]),this.spriteShader.tileSize=new Float32Array([n,n]),this.spriteShader.spriteSize=o,this.projection=new Float32Array([2/s,0,0,0,0,-2/l,0,0,0,0,-1,0,-1,1,0,1]),this.view=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.cameraX=0,this.cameraY=0,this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),this.setUpTexture();const d=new Image;d.addEventListener("load",()=>{this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d),this.setUpTexture()}),d.crossOrigin="",d.src=r}setUpTexture(){this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)}tileTextureU(t){return this.TILE_SIZE*t/this.TILES_TEXTURE_WIDTH}tileTextureV(t){return this.TILE_SIZE*t/this.TILES_TEXTURE_HEIGHT}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}update(){this.view[12]=-this.cameraX,this.view[13]=-this.cameraY}draw(t,e,s,i,r,h=!1){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),i&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,i),t.projection=this.projection,t.view=this.view,t.model=e,t.use();const a=h?this.gl.POINTS:this.gl.TRIANGLES;i?this.gl.drawElements(a,r,this.gl.UNSIGNED_SHORT,0):this.gl.drawArrays(a,0,r)}}class c{constructor(t,e,s=!1){this.timeout=t,this.callback=e,this.repeating=s,this.progress=0,this.enabled=!0}update(t){this.enabled&&(this.progress+=t,this.progress>=this.timeout&&(this.callback(),this.repeating?this.progress-=this.timeout:this.enabled=!1))}}class d{constructor(){this.active=!1,this.x=0,this.y=0,this.z=0,this.u=0,this.v=0}spawn(t,e,s,i,r,h,a){this.active=!0,this.x=t,this.y=e,this.z=s,this.u=i,this.v=r,h&&(h.sprite=this,this.controller=h),a&&(this.frames=a,this.currentFrame=0,this.frameDirection=-1,this.frameTimer=new c(100,()=>{this.currentFrame=(this.currentFrame+this.frameDirection)%this.frames.length,this.currentFrame<0&&(this.currentFrame=this.frames.length-1),this.u=this.frames[this.currentFrame][0],this.v=this.frames[this.currentFrame][1]},!0))}update(t){this.controller&&this.controller.update(t),this.frameTimer&&this.frameTimer.update(t);const e=this.oldX!==this.x||this.oldY!==this.y||this.oldZ!==this.z||this.oldU!==this.u||this.oldV!==this.v;return this.oldX=this.x,this.oldY=this.y,this.oldZ=this.z,this.oldU=this.u,this.oldV=this.v,e}}const p=128,g=20;class E{constructor(t){this.renderer=t,this.vertexBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.vertexBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,p*g,t.gl.STATIC_DRAW),this.spriteVertex=new Float32Array(5),this.sprites=[];for(let t=0;t<p;t++)this.sprites.push(new d(t))}insertSprite(t,e){this.spriteVertex[0]=e.x,this.spriteVertex[1]=e.y,this.spriteVertex[2]=e.z,this.spriteVertex[3]=e.u,this.spriteVertex[4]=e.v,this.renderer.gl.bindBuffer(this.renderer.gl.ARRAY_BUFFER,this.vertexBuffer),this.renderer.gl.bufferSubData(this.renderer.gl.ARRAY_BUFFER,t*g,this.spriteVertex)}spawnSprite(t,e,s,i,r,h=null,a=null){for(let n=0;n<p;n++){const o=this.sprites[n];if(!o.active)return o.spawn(t,e,s,i,r,h,a),this.insertSprite(n,o),o}}update(t){for(let e=0;e<p;e++){const s=this.sprites[e];s.active&&s.update(t)&&this.insertSprite(e,s)}}draw(){this.renderer.draw(this.renderer.spriteShader,null,this.vertexBuffer,null,p,!0)}}var u="\n           11\n\n  D GD   D\n 11111  11111111111111\n 222221122222222222222\n 222222222222222222222\n 222222222222222222222\n";class T{constructor(t,e){this.renderer=t,this.map=e,this.dx=0,this.dy=0,this.leftPressed=!1,this.rightPressed=!1,this.upPressed=!1,this.downPressed=!1,addEventListener("keydown",t=>{switch(t.keyCode){case 37:this.leftPressed=!0,t.preventDefault();break;case 39:this.rightPressed=!0,t.preventDefault();break;case 38:this.upPressed=!0,t.preventDefault();break;case 40:this.downPressed=!0,t.preventDefault()}}),addEventListener("keyup",t=>{switch(t.keyCode){case 37:this.leftPressed=!1,t.preventDefault();break;case 39:this.rightPressed=!1,t.preventDefault();break;case 38:this.upPressed=!1,t.preventDefault();break;case 40:this.downPressed=!1,t.preventDefault()}})}update(t){this.dx=0,this.dy=0,this.leftPressed&&(this.dx-=.1),this.rightPressed&&(this.dx+=.1),this.upPressed&&(this.dy-=.1),this.downPressed&&(this.dy+=.1),this.sprite.frameTimer.enabled=0!==this.dx,this.sprite.frameDirection=Math.sign(this.dx);const e=this.sprite.x+this.dx*t;!this.ignoreCollisions&&this.isBlocked(e,this.sprite.y)?this.dx<0?this.sprite.x=e+this.map.prevTileOffset(e):this.sprite.x=e-this.map.nextTileOffset(e):this.sprite.x=e;const s=this.sprite.y+this.dy*t;!this.ignoreCollisions&&this.isBlocked(this.sprite.x,s)?this.dy<0?this.sprite.y=s+this.map.prevTileOffset(s):this.sprite.y=s-this.map.nextTileOffset(s):this.sprite.y=s,this.renderer.cameraX=this.sprite.x+this.renderer.SPRITE_SIZE/2-this.renderer.width/2,this.renderer.cameraY=this.sprite.y+this.renderer.SPRITE_SIZE/2-this.renderer.height/2}isBlocked(t,e){return this.map.isBlocked(t,e)||this.map.isBlocked(t,e+this.renderer.SPRITE_SIZE-1)||this.map.isBlocked(t+this.renderer.SPRITE_SIZE-1,e)||this.map.isBlocked(t+this.renderer.SPRITE_SIZE-1,e+this.renderer.SPRITE_SIZE-1)}}class m{constructor(t,e){this.renderer=t,this.tiles=[];const s=u.split("\n");for(let i=0;i<s.length;i++){this.tiles.push([]);for(let r=0;r<s[i].length;r++){const h=s[i][r];if(" "===h){this.tiles[i].push(!1);continue}let a=null,n=0;switch(h){case"1":a=0;break;case"2":a=1;break;case"D":e.spawnSprite(t.SPRITE_SIZE*r,t.SPRITE_SIZE*i,.9,0,1);break;case"G":e.spawnSprite(t.SPRITE_SIZE*r,t.SPRITE_SIZE*i,.7,3,0,new T(t,this),[[3,0],[4,0],[5,0],[6,0]]),this.gib=new T(t,e,this,t.SPRITE_SIZE*r,t.SPRITE_SIZE*i)}null!==a?(e.spawnSprite(t.SPRITE_SIZE*r,t.SPRITE_SIZE*i,.1,a,n),this.tiles[i].push(!0)):this.tiles[i].push(!1)}}}isBlocked(t,e){const s=this.tiles[Math.floor(e/this.renderer.SPRITE_SIZE)];return!!s&&!0===s[Math.floor(t/this.renderer.SPRITE_SIZE)]}prevTileOffset(t){return(Math.floor(t/this.renderer.SPRITE_SIZE)+1)*this.renderer.SPRITE_SIZE-t}nextTileOffset(t){return t-Math.floor(t/this.renderer.SPRITE_SIZE)*this.renderer.SPRITE_SIZE}}const S=800,f=600;const _=new class{constructor(){this.renderer=new l(S,f),this.spriteSheet=new E(this.renderer),this.map=new m(this.renderer,this.spriteSheet),this.lastTimestamp=performance.now()}update(t){const e=t-this.lastTimestamp;this.spriteSheet.update(e),this.renderer.update(),this.lastTimestamp=t}render(){this.renderer.clear(),this.spriteSheet.draw()}},R=t=>{requestAnimationFrame(R),_.update(t),_.render()};requestAnimationFrame(R)}();
