!function(){"use strict";var t="uniform mat4 projection;uniform mat4 view;uniform mat4 model;attribute vec2 vertexPosition;attribute vec2 vertexTexCoord;varying vec2 texCoord;void main(){gl_Position=projection*view*model*vec4(vertexPosition,0.0,1.0);texCoord=vertexTexCoord;}",e="precision highp float;uniform sampler2D tex;varying vec2 texCoord;void main(){gl_FragColor=texture2D(tex,texCoord);if(gl_FragColor.a<0.1){discard;}}",i="uniform mat4 projection;uniform mat4 view;uniform mat4 model;uniform mat2 texBounds;attribute vec2 vertexPosition;attribute vec2 vertexTexCoord;varying vec2 texCoord;void main(){gl_Position=projection*view*model*vec4(vertexPosition,0.0,1.0);texCoord=vec2(mix(texBounds[0][0],texBounds[0][1],vertexTexCoord.x),mix(texBounds[1][0],texBounds[1][1],vertexTexCoord.y));}",s="precision highp float;uniform sampler2D tex;varying vec2 texCoord;void main(){gl_FragColor=texture2D(tex,texCoord);if(gl_FragColor.a<0.1){discard;}}";function r(t,e){switch(e){case t.FLOAT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:return 4;case t.FLOAT_MAT3:return 9;case t.FLOAT_MAT4:return 16}}class h{constructor(t,e,i){this.gl=t;const s=t.createShader(t.VERTEX_SHADER);t.shaderSource(s,e),t.compileShader(s);const h=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(h,i),t.compileShader(h),this.program=t.createProgram(),t.attachShader(this.program,s),t.attachShader(this.program,h),t.linkProgram(this.program),this.uniforms=[];const a=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<a;e++){const i=t.getActiveUniform(this.program,e),s=t.getUniformLocation(this.program,i.name);this[i.name]=null,this.uniforms.push({type:i.type,name:i.name,location:s})}this.attributes=[],this.stride=0;const o=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let e=0;e<o;e++){const i=t.getActiveAttrib(this.program,e),s=t.getAttribLocation(this.program,i.name),h=r(t,i.type);this.attributes.push({name:i.name,location:s,components:h}),this.stride+=4*h}}use(){this.gl.useProgram(this.program);let t=0;for(const e of this.attributes)this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.components,this.gl.FLOAT,!1,this.stride,t),t+=4*e.components;for(const t of this.uniforms)switch(t.type){case this.gl.FLOAT_MAT2:this.gl.uniformMatrix2fv(t.location,!1,this[t.name]);break;case this.gl.FLOAT_MAT4:this.gl.uniformMatrix4fv(t.location,!1,this[t.name])}}}const a="textures/tiles.png",o=128,n=32,l=16,d=64;class E{constructor(r,E){this.TILES_TEXTURE_WIDTH=o,this.TILES_TEXTURE_HEIGHT=n,this.TILE_SIZE=l,this.SPRITE_SIZE=d,this.width=r,this.height=E;const c=document.createElement("canvas");c.width=r,c.height=E,document.body.appendChild(c),this.gl=c.getContext("webgl",{antialias:!1}),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,.53,1,1),this.textureShader=new h(this.gl,t,e),this.spriteShader=new h(this.gl,i,s),this.projection=new Float32Array([2/r,0,0,0,0,-2/E,0,0,0,0,-1,0,-1,1,0,1]),this.view=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.cameraX=0,this.cameraY=0,this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),this.setUpTexture();const u=new Image;u.addEventListener("load",()=>{this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,u),this.setUpTexture()}),u.crossOrigin="",u.src=a}setUpTexture(){this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)}tileTextureU(t){return this.TILE_SIZE*t/this.TILES_TEXTURE_WIDTH}tileTextureV(t){return this.TILE_SIZE*t/this.TILES_TEXTURE_HEIGHT}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}update(){this.view[12]=-this.cameraX,this.view[13]=-this.cameraY}draw(t,e,i,s,r){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s),t.projection=this.projection,t.view=this.view,t.model=e,t.use(),this.gl.drawElements(this.gl.TRIANGLES,r,this.gl.UNSIGNED_SHORT,0)}}var c="\n           11\n\n  D GD   D\n 11111  11111111111111\n 222221122222222222222\n 222222222222222222222\n 222222222222222222222\n";class u{constructor(t,e,i=!1){this.timeout=t,this.callback=e,this.repeating=i,this.progress=0,this.enabled=!0}update(t){this.enabled&&(this.progress+=t,this.progress>=this.timeout&&(this.callback(),this.repeating?this.progress-=this.timeout:this.enabled=!1))}}let T,g,m,f;class p{constructor(t,e,i,s,r,h,a,o){this.renderer=t,this.map=e,this.x=i,this.y=s,this.dx=0,this.dy=0,this.ignoreCollisions=!1,o&&(this.frames=o,this.currentFrame=0,this.frameDirection=-1,this.frameTimer=new u(100,()=>{this.currentFrame=(this.currentFrame+this.frameDirection)%this.frames.length,this.currentFrame<0&&(this.currentFrame=this.frames.length-1),this.updateFrame(this.frames[this.currentFrame])},!0)),T||(T=new Float32Array([0,0,0,0,0,t.SPRITE_SIZE,0,1,t.SPRITE_SIZE,0,1,0,t.SPRITE_SIZE,t.SPRITE_SIZE,1,1])),g||(g=new Uint16Array([0,1,2,2,1,3])),m||(m=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,m),t.gl.bufferData(t.gl.ARRAY_BUFFER,T,t.gl.STATIC_DRAW)),f||(f=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,f),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,g,t.gl.STATIC_DRAW)),this.model=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,r,1]),this.updateFrame([h,a])}updateFrame(t){this.texBounds=new Float32Array([this.renderer.tileTextureU(t[0]),this.renderer.tileTextureU(t[0]+1),this.renderer.tileTextureV(t[1]),this.renderer.tileTextureV(t[1]+1)])}update(t){const e=this.x+this.dx*t;!this.ignoreCollisions&&this.isBlocked(e,this.y)?this.dx<0?this.x=e+this.map.prevTileOffset(e):this.x=e-this.map.nextTileOffset(e):this.x=e;const i=this.y+this.dy*t;!this.ignoreCollisions&&this.isBlocked(this.x,i)?this.dy<0?this.y=i+this.map.prevTileOffset(i):this.y=i-this.map.nextTileOffset(i):this.y=i,this.model[12]=this.x,this.model[13]=this.y,this.frameTimer&&this.frameTimer.update(t)}isBlocked(t,e){return this.map.isBlocked(t,e)||this.map.isBlocked(t,e+this.renderer.SPRITE_SIZE-1)||this.map.isBlocked(t+this.renderer.SPRITE_SIZE-1,e)||this.map.isBlocked(t+this.renderer.SPRITE_SIZE-1,e+this.renderer.SPRITE_SIZE-1)}draw(){this.renderer.spriteShader.texBounds=this.texBounds,this.renderer.draw(this.renderer.spriteShader,this.model,m,f,g.length)}}const _=.7;class x extends p{constructor(t,e,i,s){super(t,e,i,s,_,2,0),this.top=new p(t,e,i,s-t.SPRITE_SIZE,_,2,0),this.bottom=new p(t,e,i,s,_,3,0,[[3,0],[4,0],[5,0],[6,0]]),this.top.ignoreCollisions=!0,this.bottom.ignoreCollisions=!0,this.leftPressed=!1,this.rightPressed=!1,this.upPressed=!1,this.downPressed=!1,addEventListener("keydown",t=>{switch(t.keyCode){case 37:this.leftPressed=!0,t.preventDefault();break;case 39:this.rightPressed=!0,t.preventDefault();break;case 38:this.upPressed=!0,t.preventDefault();break;case 40:this.downPressed=!0,t.preventDefault()}}),addEventListener("keyup",t=>{switch(t.keyCode){case 37:this.leftPressed=!1,t.preventDefault();break;case 39:this.rightPressed=!1,t.preventDefault();break;case 38:this.upPressed=!1,t.preventDefault();break;case 40:this.downPressed=!1,t.preventDefault()}})}update(t){this.dx=0,this.dy=0,this.leftPressed&&(this.dx-=.1),this.rightPressed&&(this.dx+=.1),this.upPressed&&(this.dy-=.1),this.downPressed&&(this.dy+=.1),super.update(t),this.top.x=this.x,this.top.y=this.y-this.renderer.SPRITE_SIZE,this.bottom.x=this.x,this.bottom.y=this.y,this.bottom.frameDirection=Math.sign(this.dx),this.bottom.frameTimer.enabled=0!==this.dx,this.top.update(t),this.bottom.update(t),this.renderer.cameraX=this.bottom.x+this.renderer.SPRITE_SIZE/2-this.renderer.width/2,this.renderer.cameraY=this.bottom.y+this.renderer.SPRITE_SIZE/2-this.renderer.height/2}isBlocked(t,e){return this.top.isBlocked(t,e-this.renderer.SPRITE_SIZE)||this.bottom.isBlocked(t,e)}draw(){this.bottom.draw(),this.top.draw()}}class R{constructor(t,e){this.renderer=t,this.tiles=[];const i=c.split("\n"),s=[],r=[];let h=0;for(let a=0;a<i.length;a++){this.tiles.push([]);for(let o=0;o<i[a].length;o++){const n=i[a][o];if(" "===n){this.tiles[a].push(!1);continue}let l=null,d=0;switch(n){case"1":l=0;break;case"2":l=1;break;case"D":e.push(new p(t,this,t.SPRITE_SIZE*o,t.SPRITE_SIZE*a,.9,0,1));break;case"G":e.push(new x(t,this,t.SPRITE_SIZE*o,t.SPRITE_SIZE*a))}null!==l?(this.tiles[a].push(!0),s.push(t.SPRITE_SIZE*o,t.SPRITE_SIZE*a,t.tileTextureU(l),t.tileTextureV(d),t.SPRITE_SIZE*o,t.SPRITE_SIZE*(a+1),t.tileTextureU(l),t.tileTextureV(d+1),t.SPRITE_SIZE*(o+1),t.SPRITE_SIZE*a,t.tileTextureU(l+1),t.tileTextureV(d),t.SPRITE_SIZE*(o+1),t.SPRITE_SIZE*(a+1),t.tileTextureU(l+1),t.tileTextureV(d+1)),r.push(h,h+1,h+2,h+1,h+2,h+3),h+=4):this.tiles[a].push(!1)}}this.vertices=new Float32Array(s),this.indices=new Uint16Array(r),this.vertexBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.vertexBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,this.vertices,t.gl.STATIC_DRAW),this.indexBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,this.indices,t.gl.STATIC_DRAW),this.model=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}isBlocked(t,e){const i=this.tiles[Math.floor(e/this.renderer.SPRITE_SIZE)];return!!i&&!0===i[Math.floor(t/this.renderer.SPRITE_SIZE)]}prevTileOffset(t){return(Math.floor(t/this.renderer.SPRITE_SIZE)+1)*this.renderer.SPRITE_SIZE-t}nextTileOffset(t){return t-Math.floor(t/this.renderer.SPRITE_SIZE)*this.renderer.SPRITE_SIZE}draw(){this.renderer.draw(this.renderer.textureShader,this.model,this.vertexBuffer,this.indexBuffer,this.indices.length)}}const S=800,I=600;const A=new class{constructor(){this.renderer=new E(S,I),this.entities=[],this.map=new R(this.renderer,this.entities),this.lastTimestamp=performance.now()}update(t){const e=t-this.lastTimestamp;this.entities.forEach(t=>t.update(e)),this.renderer.update(),this.lastTimestamp=t}render(){this.renderer.clear(),this.map.draw(),this.entities.forEach(t=>t.draw())}},P=t=>{requestAnimationFrame(P),A.update(t),A.render()};requestAnimationFrame(P)}();
