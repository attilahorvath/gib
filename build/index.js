!function(){"use strict";var t="uniform mat4 projection;uniform mat4 view;attribute vec3 vertex0Position;attribute vec2 vertex1TexCoord;varying vec2 texCoord;void main(){gl_PointSize=64.0;gl_Position=projection*view*vec4(vertex0Position,1.0);texCoord=vertex1TexCoord;}",e="precision highp float;uniform sampler2D tex;varying vec2 texCoord;void main(){vec2 texCoord=mix((vec2(16.0)*texCoord)/vec2(128.0,32.0),(vec2(16.0)*(texCoord+vec2(1.0)))/vec2(128.0,32.0),gl_PointCoord);gl_FragColor=texture2D(tex,texCoord);if(gl_FragColor.a<0.1){discard;}}",s="uniform mat4 projection;uniform mat4 view;uniform float time;attribute vec2 vertex0Position;attribute vec3 vertex1Color;attribute vec2 vertex2Velocity;attribute float vertex3Emitted;varying vec4 color;void main(){float age=time-vertex3Emitted;vec2 position=vertex0Position+vertex2Velocity*age;gl_PointSize=4.0;gl_Position=projection*view*vec4(position,0.9,1.0);color=vec4(vertex1Color,1.0-smoothstep(0.0,200.0,age));}",i="precision highp float;varying vec4 color;void main(){gl_FragColor=color;}";const r=(t,e)=>{switch(e){case t.FLOAT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:return 4;case t.FLOAT_MAT3:return 9;case t.FLOAT_MAT4:return 16}};class h{constructor(t,e,s){this.gl=t;const i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,e),t.compileShader(i);const h=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(h,s),t.compileShader(h),this.program=t.createProgram(),t.attachShader(this.program,i),t.attachShader(this.program,h),t.linkProgram(this.program),this.uniforms=[];const a=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<a;e++){const s=t.getActiveUniform(this.program,e),i=t.getUniformLocation(this.program,s.name);this[s.name]=null,this.uniforms.push({type:s.type,name:s.name,location:i})}this.attributes=[],this.stride=0;const n=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let e=0;e<n;e++){const s=t.getActiveAttrib(this.program,e),i=t.getAttribLocation(this.program,s.name),h=r(t,s.type);this.attributes.push({name:s.name,location:i,components:h}),this.stride+=4*h}this.attributes.sort((t,e)=>t.name<e.name?-1:1)}use(){this.gl.useProgram(this.program);let t=0;for(const e of this.attributes)this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.components,this.gl.FLOAT,!1,this.stride,t),t+=4*e.components;for(const t of this.uniforms)switch(t.type){case this.gl.FLOAT:this.gl.uniform1f(t.location,this[t.name]);break;case this.gl.FLOAT_VEC2:this.gl.uniform2fv(t.location,this[t.name]);break;case this.gl.FLOAT_MAT2:this.gl.uniformMatrix2fv(t.location,!1,this[t.name]);break;case this.gl.FLOAT_MAT4:this.gl.uniformMatrix4fv(t.location,!1,this[t.name])}}}class a{constructor(){const r=document.createElement("canvas");r.width=800,r.height=600,document.body.appendChild(r),this.gl=r.getContext("webgl",{antialias:!1}),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,.53,1,1),this.spriteShader=new h(this.gl,t,e),this.particleShader=new h(this.gl,s,i),this.projection=new Float32Array([.0025,0,0,0,0,-2/600,0,0,0,0,-1,0,-1,1,0,1]),this.view=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.cameraX=0,this.cameraY=0,this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),this.setUpTexture();const a=new Image;a.addEventListener("load",()=>{this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a),this.setUpTexture()}),a.crossOrigin="",a.src="textures/tiles.png"}setUpTexture(){this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)}tileTextureU(t){return 16*t/128}tileTextureV(t){return 16*t/32}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}update(){this.view[12]=-this.cameraX,this.view[13]=-this.cameraY}draw(t,e,s,i,r,h=!1){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),i&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,i),t.projection=this.projection,t.view=this.view,t.model=e,t.use();const a=h?this.gl.POINTS:this.gl.TRIANGLES;i?this.gl.drawElements(a,r,this.gl.UNSIGNED_SHORT,0):this.gl.drawArrays(a,0,r)}}class n{constructor(t,e,s=!1){this.timeout=t,this.callback=e,this.repeating=s,this.progress=0,this.enabled=!0}update(){this.enabled&&(this.progress+=1e3/60,this.progress>=this.timeout&&(this.callback(),this.repeating?this.progress-=this.timeout:this.enabled=!1))}}class o{constructor(){this.active=!1,this.x=0,this.y=0,this.z=0,this.u=0,this.v=0}spawn(t,e,s,i,r,h,a){this.active=!0,this.x=t,this.y=e,this.z=s,this.u=i,this.v=r,h&&(h.sprite=this,this.controller=h),a&&(this.frames=a,this.currentFrame=0,this.frameDirection=-1,this.frameTimer=new n(100,()=>{this.currentFrame=(this.currentFrame+this.frameDirection)%this.frames.length,this.currentFrame<0&&(this.currentFrame=this.frames.length-1),this.u=this.frames[this.currentFrame][0],this.v=this.frames[this.currentFrame][1]},!0))}update(){this.controller&&this.controller.update(),this.frameTimer&&this.frameTimer.update();const t=this.oldX!==this.x||this.oldY!==this.y||this.oldZ!==this.z||this.oldU!==this.u||this.oldV!==this.v;return this.oldX=this.x,this.oldY=this.y,this.oldZ=this.z,this.oldU=this.u,this.oldV=this.v,t}}const l=512,c=20;class d{constructor(t){this.renderer=t,this.vertexBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.vertexBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,l*c,t.gl.STATIC_DRAW),this.spriteVertex=new Float32Array(c/4),this.sprites=[];for(let t=0;t<l;t++)this.sprites.push(new o(t))}insertSprite(t,e){this.spriteVertex[0]=e.x+32,this.spriteVertex[1]=e.y+32,this.spriteVertex[2]=e.z,this.spriteVertex[3]=e.u,this.spriteVertex[4]=e.v,this.renderer.gl.bindBuffer(this.renderer.gl.ARRAY_BUFFER,this.vertexBuffer),this.renderer.gl.bufferSubData(this.renderer.gl.ARRAY_BUFFER,t*c,this.spriteVertex)}spawnSprite(t,e,s,i,r,h=null,a=null){for(let n=0;n<l;n++){const o=this.sprites[n];if(!o.active)return o.spawn(t,e,s,i,r,h,a),this.insertSprite(n,o),o}}update(){for(let t=0;t<l;t++){const e=this.sprites[t];e.active&&e.update()&&this.insertSprite(t,e)}}draw(){this.renderer.draw(this.renderer.spriteShader,null,this.vertexBuffer,null,l,!0)}}var u="\n  1\n                                                               1111\n                                                  22222222222222        1\n2222222222222222222222222222222 G  222222222222222\n2                                        R  R  R                              111\n2                                                    11111111111\n2                11111111111111111111111111111111111122222222222       111\n2                222222                                        2\n2         1111111222222                                        2              11111\n2      1112222222222222                                        2\n2      2222222222222222                                        2         111\n21111112222222222222222                                        2\n22222222222222222222222                                        2222222222222222222\n";class p{constructor(t){this.map=t,this.dx=0,this.dy=0,this.ax=0,this.ay=0,this.hitboxX=0,this.hitboxY=0,this.hitboxW=64,this.hitboxH=64}get x(){return this.sprite.x}get y(){return this.sprite.y}set x(t){this.sprite.x=t}set y(t){this.sprite.y=t}get left(){return this.x+this.hitboxX}get right(){return this.x+this.hitboxX+this.hitboxW-1}get top(){return this.y+this.hitboxY}get bottom(){return this.y+this.hitboxY+this.hitboxH-1}update(){this.dx+=this.ax*(1e3/60),this.dy+=this.ay*(1e3/60),this.dx>.5?this.dx=.5:this.dx<-.5&&(this.dx=-.5),this.dy>2?this.dy=2:this.dy<-2&&(this.dy=-2),this.x+=this.dx*(1e3/60),this.tileAt()&&(this.dx<0?this.x+=this.map.prevTileOffset(this.left):this.x-=this.map.nextTileOffset(this.right)+1),this.y+=this.dy*(1e3/60),this.tileAt()&&(this.dy<0?this.y+=this.map.prevTileOffset(this.top):this.y-=this.map.nextTileOffset(this.bottom)+1)}tileAt(t=0,e=0){return this.map.tileAt(this.left+t,this.top+e)||this.map.tileAt(this.left+t,this.bottom+e)||this.map.tileAt(this.right+t,this.top+e)||this.map.tileAt(this.right+t,this.bottom+e)}}class g extends p{constructor(t,e,s,i){super(e),this.renderer=t,this.input=s,this.particleSystem=i,this.direction=0,this.lastDirection=0}update(){const t=this.tileAt(0,1);t?(this.ay=0,this.dy=0):this.tileAt(0,-1)?(this.ay=.002,this.dy=0):this.ay=.002,this.input.pressed(4)?(this.ax>0&&(this.ax=0),this.tileAt(-1,0)?(this.dx=0,this.ax=0):this.ax-=1e-4,this.direction=-1,this.lastDirection=0):this.input.pressed(8)?(this.ax<0&&(this.ax=0),this.tileAt(1,0)?(this.dx=0,this.ax=0):this.ax+=1e-4,this.direction=1,this.lastDirection=0):(0!==this.direction&&(this.ax=-this.ax,this.lastDirection=this.direction,this.direction=0),(this.lastDirection>0&&this.dx<.001||this.lastDirection<0&&this.dx>.001||this.tileAt(-1,0)||this.tileAt(1,0))&&(this.dx=0,this.ax=0)),this.ax>.002?this.ax=.002:this.ax<-.002&&(this.ax=-.002),this.input.justPressed(32)&&0===this.ay&&(this.dy=-.8),super.update(),this.dx<-.1?this.kickUpDirt(this.x+64-2,t):this.dx>.1&&this.kickUpDirt(this.x+1,t),this.sprite.frameTimer.timeout=t?100:40,this.sprite.frameTimer.enabled=0!==this.direction,this.sprite.frameDirection=Math.sign(this.direction),this.renderer.cameraX=this.x+32-400,this.renderer.cameraY=this.y+32-300}kickUpDirt(t,e){if(!e)return;const s=2*Math.random(),i="1"==e?0:.4,r="1"==e?.8:.27,h="1"==e?.33:0,a=t<this.x+32?-1:1;for(let e=0;e<s;e++)this.particleSystem.emitParticle(t,this.y+64-1,i,r,h,a*Math.random()*.25,.25*-Math.random())}}class m extends p{constructor(t,e){super(t),this.gib=e,this.hitboxX=8,this.hitboxY=4,this.hitboxW=56,this.hitboxH=20,this.falling=!1}update(){this.falling=!(this.gib.left-25>this.right||this.gib.right+25<this.left||this.gib.bottom<this.top),this.tileAt(0,1)?(this.ay=0,this.dy=0,this.falling=!1):this.falling&&(this.ay=.002),super.update()}}class x{constructor(t,e,s,i){const r=new g(t,this,s,i);this.tiles=[];const h=u.split("\n");for(let t=0;t<h.length;t++){this.tiles.push([]);for(let s=0;s<h[t].length;s++){const i=h[t][s];let a=null,n=0;switch(i){case"1":a=0;break;case"2":a=1;break;case"R":e.spawnSprite(64*s,64*t,.8,6,0,new m(this,r));break;case"D":e.spawnSprite(64*s,64*t,.8,0,1);break;case"G":e.spawnSprite(64*s,64*t,.7,2,0,r,[[2,0],[3,0],[4,0],[5,0]])}null!==a?(e.spawnSprite(64*s,64*t,.1,a,n),this.tiles[t].push(i)):this.tiles[t].push(null)}}}tileAt(t,e){const s=this.tiles[Math.floor(e/64)];return s?s[Math.floor(t/64)]:null}prevTileOffset(t){return 64*(Math.floor(t/64)+1)-t}nextTileOffset(t){return t-64*Math.floor(t/64)}}const f="ArrowUp",A="ArrowDown",v="ArrowLeft",y="ArrowRight",T="KeyW",b="KeyS",E="KeyA",R="KeyD",_="KeyX",P="KeyZ",w="KeyK",F="KeyJ",S="Space";class D{constructor(){this.keysPressed=0,this.lastPressed=0,this.keysJustPressed=0,this.keysJustReleased=0,addEventListener("keydown",t=>{switch(t.code){case f:case T:this.keysPressed|=1,t.preventDefault();break;case A:case b:this.keysPressed|=2,t.preventDefault();break;case v:case E:this.keysPressed|=4,t.preventDefault();break;case y:case R:this.keysPressed|=8,t.preventDefault();break;case _:case w:case S:this.keysPressed|=32,t.preventDefault();break;case P:case F:this.keysPressed|=64,t.preventDefault()}}),addEventListener("keyup",t=>{switch(t.code){case f:case T:this.keysPressed&=-2,t.preventDefault();break;case A:case b:this.keysPressed&=-3,t.preventDefault();break;case v:case E:this.keysPressed&=-5,t.preventDefault();break;case y:case R:this.keysPressed&=-9,t.preventDefault();break;case _:case w:case S:this.keysPressed&=-33,t.preventDefault();break;case P:case F:this.keysPressed&=-65,t.preventDefault()}})}update(){this.keysJustPressed=this.keysPressed&~this.lastPressed,this.keysJustReleased=~this.keysPressed&this.lastPressed,this.lastPressed=this.keysPressed}pressed(t){return(this.keysPressed&t)===t}justPressed(t){return(this.keysJustPressed&t)===t}justReleased(t){return(this.keysJustReleased&t)===t}}const k=128,U=32;class B{constructor(t){this.renderer=t,this.vertexBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.vertexBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,k*U,t.gl.STATIC_DRAW),this.particleVertex=new Float32Array(U/4),this.nextIndex=0,this.time=0}emitParticle(t,e,s,i,r,h,a){this.particleVertex[0]=t,this.particleVertex[1]=e,this.particleVertex[2]=s,this.particleVertex[3]=i,this.particleVertex[4]=r,this.particleVertex[5]=h,this.particleVertex[6]=a,this.particleVertex[7]=this.time,this.renderer.gl.bindBuffer(this.renderer.gl.ARRAY_BUFFER,this.vertexBuffer),this.renderer.gl.bufferSubData(this.renderer.gl.ARRAY_BUFFER,this.nextIndex*U,this.particleVertex),this.nextIndex=(this.nextIndex+1)%k}update(){this.time+=1e3/60}draw(){this.renderer.particleShader.time=this.time,this.renderer.draw(this.renderer.particleShader,null,this.vertexBuffer,null,k,!0)}}const C=new class{constructor(){this.renderer=new a,this.input=new D,this.spriteSheet=new d(this.renderer),this.particleSystem=new B(this.renderer),this.map=new x(this.renderer,this.spriteSheet,this.input,this.particleSystem),this.lastTimestamp=0,this.timeAccumulator=0}update(t){const e=t-this.lastTimestamp;for(this.lastTimestamp=t,this.timeAccumulator+=e;this.timeAccumulator>=1e3/60;)this.input.update(),this.spriteSheet.update(),this.particleSystem.update(),this.renderer.update(),this.timeAccumulator-=1e3/60}render(){this.renderer.clear(),this.spriteSheet.draw(),this.particleSystem.draw()}},V=t=>{requestAnimationFrame(V),C.update(t),C.render()};requestAnimationFrame(V)}();
